{
	# Optional: email for ACME account; can be set via env if needed
	# email {$ACME_EMAIL}
	# Enables automatic HTTPS, HTTP/2/3 by default
}

# Frontend host: serves static via frontend container
{env.DOMAIN} {
	encode zstd gzip

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "no-referrer-when-downgrade"
		X-Frame-Options "DENY"
		Permissions-Policy "geolocation=(), camera=(), microphone=()"
	}

	# Вебхук GitHub: строго по пути и только он уходит в content-sync
	handle_path /.hooks/redpen-publish {
		# Без кеша на этот эндпоинт
		header {
			Cache-Control "no-store"
		}
		reverse_proxy content-sync:9000
	}

	# Любые другие /.hooks/* — 404
	handle_path /.hooks/* {
		header {
			Cache-Control "no-store"
		}
		respond 404
	}

	# Остальной трафик — на фронтенд
	reverse_proxy frontend:80
}
# API host: reverse proxy to FastAPI; add CORS headers and handle preflight
{env.API_HOST} {
	encode zstd gzip

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "no-referrer-when-downgrade"
		X-Frame-Options "DENY"
		Permissions-Policy "geolocation=(), camera=(), microphone=()"

		# Basic CORS; бекенд тоже делает CORS
		Access-Control-Allow-Origin {$FRONTEND_ORIGIN}
		Access-Control-Allow-Methods "GET, POST, PUT, OPTIONS"
		Access-Control-Allow-Headers "*"
		Access-Control-Allow-Credentials "true"
	}

	# Быстрый preflight
	handle_path /api/* {
		@preflight {
			method OPTIONS
		}
		respond @preflight 204

		# Остальные методы /api/* — в бекенд
		reverse_proxy api:8080
	}
}
