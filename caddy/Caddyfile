{
	# Use Let's Encrypt staging (no rate limits for testing)
	# don't forget to uncomment Strict-Transport-Security
	acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

{
	# Optional: email for ACME account; can be set via env if needed
	# email {$ACME_EMAIL}
	# Enables automatic HTTPS, HTTP/2/3 by default
}

# Frontend host: serves static via frontend container
{$DOMAIN} {
  encode zstd gzip

  header {
   # Temporarily disable HSTS for staging certificate testing
   # Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    Referrer-Policy "no-referrer-when-downgrade"
    X-Frame-Options "DENY"
    Permissions-Policy "geolocation=(), camera=(), microphone=()"
  }

  route {
    # Тестовый зонд: сохраняем полный путь
    handle /.hooks/probe {
      header {
        Cache-Control "no-store"
        X-Debug "hook-probe"
      }
      respond 418
    }

    # Основной вебхук: сохраняем полный путь (НЕ handle_path)
    handle /.hooks/redpen-publish {
      header {
        Cache-Control "no-store"
      }
      reverse_proxy content-sync:9000
    }

    # Любые другие /.hooks/* → 404 (без среза префикса)
    handle /.hooks/* {
      header {
        Cache-Control "no-store"
      }
      respond 404
    }

    # Всё остальное — фронтенд
    handle {
      reverse_proxy frontend:80
    }
  }
}
# API host: Caddy handles CORS
{$API_HOST} {
	encode zstd gzip

	header {
	#	Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "no-referrer-when-downgrade"
		X-Frame-Options "DENY"
		Permissions-Policy "geolocation=(), camera=(), microphone=()"
	}

	# Быстрый preflight с явными CORS заголовками
	@preflight {
		method OPTIONS
		path /api/*
	}
	handle @preflight {
		header Access-Control-Allow-Origin "{$DOMAIN}"
		header Access-Control-Allow-Credentials "true"
		header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
		header Access-Control-Allow-Headers "Content-Type, Authorization, X-CSRF-Token"
		header Access-Control-Max-Age "86400"
		respond 204
	}

	# Проксирование всех остальных /api/* в бекенд
	reverse_proxy api:8080 {
		# Убедимся, что заголовки добавляются и к обычным ответам
		header_up Access-Control-Allow-Origin "{$DOMAIN}"
		header_up Access-Control-Allow-Credentials "true"
	}
}
