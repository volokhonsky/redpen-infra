{
	# Optional: email for ACME account; can be set via env if needed
	# email {$ACME_EMAIL}
	# Enables automatic HTTPS, HTTP/2/3 by default
}

# Frontend host: serves static via frontend container
{$DOMAIN} {
  encode zstd gzip

  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    Referrer-Policy "no-referrer-when-downgrade"
    X-Frame-Options "DENY"
    Permissions-Policy "geolocation=(), camera=(), microphone=()"
  }

  # Разрешаем только конкретный POST-хук
  @ghhook {
    method POST
    path /.hooks/redpen-publish
  }
  header @ghhook {
    Cache-Control "no-store"
  }
  reverse_proxy @ghhook content-sync:9000

  # Все остальные /.hooks/* блокируем 404
  @otherhooks {
    path /.hooks/*
    not path /.hooks/redpen-publish
  }
  respond @otherhooks 404

  # Test probe hook: returns 418 with a debug header (does not change existing hooks)
  @testhook {
    path /.hooks/probe
  }
  header @testhook {
    Cache-Control "no-store"
    X-Debug "hook-probe"
  }
  respond @testhook 418

  reverse_proxy frontend:80
}
# API host: reverse proxy to FastAPI; add CORS headers and handle preflight
{$API_HOST} {
	encode zstd gzip

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "no-referrer-when-downgrade"
		X-Frame-Options "DENY"
		Permissions-Policy "geolocation=(), camera=(), microphone=()"

		# Basic CORS for browsers; backend also enforces CORS
		Access-Control-Allow-Origin {$FRONTEND_ORIGIN}
		Access-Control-Allow-Methods "GET, POST, PUT, OPTIONS"
		Access-Control-Allow-Headers "*"
		Access-Control-Allow-Credentials "true"
	}

	# Быстрый preflight
	@preflight {
		method OPTIONS
		path /api/*
	}
	respond @preflight 204

	# Проксирование всех остальных /api/* в бекенд
	reverse_proxy api:8080
}
