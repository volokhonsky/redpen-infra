# Идентификаторы элементов аннотаций

Этот документ объясняет систему идентификаторов, используемую для элементов аннотаций в приложении RedPen.

## Обзор

Для упрощения тестирования и отладки уникальные идентификаторы были добавлены ко всем элементам аннотаций (кружкам и всплывающим окнам). Во всех актуальных материалах id аннотации обязателен, и идентификаторы элементов основаны на собственном ID аннотации. Для старых (legacy) материалов без id временно поддерживается fallback-режим генерации из ID страницы и индекса.

## Форматы идентификаторов

### Элементы кружков

Кружки (визуальные маркеры для аннотаций) используют следующий формат ID:
```
circle-{annotation_id}
```

Для legacy-материалов, где ещё встречаются аннотации без id (исторический контент), временно поддерживается следующий fallback (не рекомендуется для нового контента):
```
circle-{page_id}-{index}
```

Пример: `circle-ann-page7-1` или `circle-page_007-1`

### Элементы всплывающих окон

Всплывающие окна (комментарии, которые появляются при наведении/клике на кружки) используют следующий формат ID:
```
{annotation_id}
```

Для legacy-материалов, где ещё встречаются аннотации без id (исторический контент), временно поддерживается следующий fallback (не рекомендуется для нового контента):
```
ann-{page_id}-{index}
```

Пример: `ann-page7-1` или `ann-page_007-1`

## Использование в тестировании

Эти идентификаторы могут использоваться в тестовых скриптах для легкого поиска и взаимодействия с конкретными элементами аннотаций:

```javascript
// Пример использования Playwright
await page.click('#circle-ann-page7-1');
await expect(page.locator('#ann-page7-1')).toBeVisible();
```

```python
# Пример использования Playwright в Python
page.click('#circle-ann-page7-1')
expect(page.locator('#ann-page7-1')).to_be_visible()
```

## Реализация

Идентификаторы устанавливаются в функции `repositionAnnotations` в `annotations.js`. В актуальном контенте аннотации всегда имеют `id`; показанный ниже fallback остаётся только для совместимости со старыми материалами:

```javascript
// Для кружков
circle.id = 'circle-' + (a.id || `${currentPageId}-${i+1}`);

// Для всплывающих окон
popup.id = (a.id || `ann-${currentPageId}-${i+1}`);
```