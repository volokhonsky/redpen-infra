# Спецификация формата аннотаций

## Общая структура
Файл состоит из одной или нескольких аннотаций. Каждая аннотация представляет собой YAML-документ с frontmatter и телом комментария.

## Разделители
- Каждая аннотация начинается с `~~~meta` на отдельной строке
- После frontmatter следует `~~~` на отдельной строке
- Между аннотациями должна быть как минимум одна пустая строка для лучшей читаемости

## Frontmatter
Обязательные поля:
- `type`: тип аннотации (см. раздел "Типы аннотаций")

Необязательные поля:
- `id`: уникальный идентификатор аннотации
- `target`: идентификатор цели, к которой относится аннотация. Если значение имеет формат `[X, Y]`, где `X` и `Y` — числовые значения, то это интерпретируется как координаты точки на изображении страницы

## Типы аннотаций
В системе используются три типа аннотаций:
- `general` - общий комментарий к странице или документу (не может иметь поля `target`)
- `main` - основной комментарий к тексту/области
- `comment` - дополнительный комментарий или замечание
## Тело комментария
- Следует сразу после `~~~`
- Может содержать любой валидный markdown
- Может быть многострочным
- Не должно содержать линий, начинающихся с `~~~meta` или `~~~` (это зарезервировано для разделителей)

## Примеры

### Пример 1: Аннотация с target
```
~~~meta
type: main
id: ann-page7-1
target: page_007_line003
~~~

Это не вопрос, это утверждение в форме вопроса. Тебе пытаются сразу навязать идею о том, что СССР быстро восстановил хозяйство и экономику.
```

### Пример 2: Аннотация с координатами
```
~~~meta
type: comment
id: ann-page8-2
target: [450, 320]
~~~

Начало работы по восстановлению представлено как само собой разумеющееся «колоссальных усилий», но нет ни слова о жертвах.
```

### Пример 3: Аннотация с идентификатором цели
```
~~~meta
type: main
id: ann-page10-1
target: page_010_block1
~~~

Основной комментарий к блоку текста на странице.
```

### Пример 4: Аннотация типа general
```
~~~meta
type: general
id: ann-page10-3
~~~

Общий комментарий к странице.
```

## Правила валидации
1. Каждый документ должен начинаться с `~~~meta`.
2. Обязательно только поле `type`. Поля `id` и `target` являются необязательными.
3. Если поле `id` присутствует, оно должно быть уникальным в пределах всех аннотаций.
4. После метаданных должен быть разделитель `~~~`.
5. Между аннотациями должна быть пустая строка.
6. Содержимое комментария не должно начинаться с `~~~meta` или `~~~`.
7. Тип аннотации должен быть одним из перечисленных в разделе "Типы аннотаций".
8. Если поле `target` имеет формат `[X, Y]`, где `X` и `Y` — числовые значения, то это интерпретируется как координаты.

## Рекомендации по именованию
- `id`: формат `ann-pageN-М`, где `N` — номер страницы, `М` — порядковый номер аннотации на странице.

## Обработка
При парсинге:
1. Разбить файл по `~~~meta` и `~~~` с учётом пустых строк.
2. Для каждой аннотации:
   - Извлечь и валидировать метаданные.
   - Остальной текст считать телом комментария.
3. Если поле `id` присутствует, проверить его уникальность.
4. Если поле `target` имеет формат `[X, Y]`, где `X` и `Y` — числовые значения, то это интерпретируется как координаты и преобразуется в список целых чисел для поля `coords` в JSON.

## Формат JSON

При конвертации в JSON формат, поля из markdown преобразуются следующим образом:
- `type` -> `annType`
- `target` -> `targetBlock` (если `target` не содержит координаты)
- `target` -> `coords` (если `target` имеет формат `[X, Y]`, преобразуется в массив чисел)
- `id` -> `id`
- Текст комментария -> `text`

Пример JSON:
```json
[
  {
    "id": "ann-page8-1",
    "text": "Автор использует термин «самая кровопролитная война» без источника и без указания методики оценки.",
    "annType": "main",
    "coords": [
      350,
      220
    ]
  },
  {
    "id": "ann-page8-2",
    "text": "Начало работы по восстановлению представлено как само собой разумеющееся «колоссальных усилий».",
    "annType": "comment",
    "coords": [
      450,
      320
    ]
  }
]
```

---

Эта спецификация описывает структуру и правила формирования аннотаций, используемых в проекте. Убедитесь, что все аннотации соответствуют указанным форматам и правилам для обеспечения корректной обработки и отображения.
