# Текущее состояние системы RedPen (обзор)

Этот документ фиксирует текущее состояние системы и расположение ключевых файлов в контексте задач просмотра учебника с аннотациями и режима редактора, а также минимального бэкенда (шаг 1/5) и инфраструктуры.

## Что делает система сейчас

- Просмотр учебника с аннотациями:
  - Рендер изображений страниц, кружков‑аннотаций и всплывающих поп‑апов.
  - Навигация по страницам, включая поддержку параметра `?page=N` и обновление адресной строки при кликах по номерам страниц/Prev/Next (история браузера поддерживается через `pushState`).
  - Мобильный режим: отдельные оверлеи/навигация и показ комментариев.

- Режим редактора (включается `?editor=1` или глобальным флагом):
  - Справа вместо ленты комментариев монтируется панель редактирования.
  - Клик по пустому месту изображения задаёт координаты; клик по кружку подгружает черновик (тип, текст, координаты) и подсвечивает маркер.
  - Тип "general" (общий комментарий страницы):
    - Если на странице он уже есть — в редакторе он подставляется отложенно, когда контент появляется (не ставим «Загрузка…» в textarea).
    - При переключении типа на general — подставляется его текст (или создаётся драфт, если его нет).
    - Координаты для general не используются (поле скрывается/отключается).
  - Защита от потери несохранённых изменений:
    - При попытке уйти со «грязной» формы (клик по другому маркеру/пустому месту/смена типа) — спрашивается подтверждение; при отказе остаёмся в редактировании.
    - В режиме создания (new) смена координат по клику разрешена без подтверждения.
  - «Показать» и «Отправить»:
    - «Показать» — локально применяет изменения: создаёт/обновляет маркер, поп‑ап, поддерживает hover, обновляет правый блок для general, синхронизирует baseline (форма становится «чистой»).
    - «Отправить» — заглушка для будущего сервера: в текущей реализации предусмотрены клиентские заглушки/моки; при реальном сервере будет POST/PUT к API, обработка 401/409, обновление serverPageSha.

- Бэкенд API (шаг 1/5 готов, в Docker):
  - Лёгкий HTTP‑сервис на FastAPI/Uvicorn, принимает JSON и складывает в файлы (`/data/inbox/YYYYMMDD/uuid.json`), есть health‑check.
  - Создаётся экономичный Docker‑образ для выката на Vultr.
  - В планах (шаг 2/5): эндпоинты страниц/аннотаций (GET/POST/PUT), `serverPageSha`; далее — аутентификация, CSRF, optimistic locking.

## Где что лежит (ключевые файлы и их роли)

Фронтенд (шаблоны и логика просмотра/редактора)
- `templates/js/main.js`
  - Основной загрузчик страниц: `loadPage(pageNum)`, подгрузка изображений и `annotations` JSON, разметка глобальных комментариев, генерация пагинации, интеграция с mobile UI.
  - Поддержка `?page=N` (логическая страница) и обновление нумерации/адресной строки.
- `templates/js/layout.js`
  - Разметка и поведение общего лейаута, в т.ч. адаптивных блоков (используется `main.js`).
- `templates/js/comment-content.js`
  - Рендер контента комментариев/поп‑апов (HTML из текста), генерация и позиционирование поп‑апа относительно кружка.
- `templates/js/annotations.js`
  - Отрисовка кружков, пересчёт позиций, поведение hover/click (используется `main.js` и редактором).
- `templates/js/mobile.js`
  - Мобильные оверлеи/навигация, кнопки, показ комментария в мобильном режиме.
- `templates/js/redpen-editor-panel.js`
  - Панель редактора: вёрстка формы, методы `setDraft`/`getDraft`, валидация (тип/контент/coords), включение/отключение кнопок «Показать/Отправить/Отмена».
- `templates/js/redpen-editor-bootstrap.js`
  - Включение режима редактора по флагу; монтирование панели в правой колонке (`#global-comment-container`).
  - Делегированные клики: по изображению — заполнять coords, по маркеру — подгружать драфт и подсвечивать.
  - Поддержка general (отложенная подстановка), хранение state (draft, baseline, editing mode), защита от потери изменений.
  - Локальный предпросмотр «Показать»: upsert маркера (класс `circle`, data‑атрибуты), обновление/создание поп‑апа с поддержкой hover, синхронизация baseline.
- `templates/document_index.html`
  - Базовая страница просмотра: контейнеры `#image-container` (изображение/оверлеи), `#global-comment-container` (правая панель), верхняя пагинация; подключение JS.

Логика URL/режимов
- `?page=N` — начальная загрузка страницы N и обновление адресной строки при навигации (в обычном и в редакторском режимах).
- `?editor=1` — включает editor mode; во всех ссылках пагинации сохраняется `&editor=1`.

Бэкенд API (минимальный сервис и Docker)
- `scripts/api/main.py`
  - FastAPI‑приложение: CORS (конфигурируемые Origins), логи, обработчики:
    - `GET /api/health` — статус ok.
    - `POST /api/store` — принять JSON‑объект, добавить служебные поля `receivedAt`/`remoteAddr` и положить в файловое хранилище (`inbox/дата/uuid.json`), логировать путь/размер.
- `scripts/api/storage.py`
  - Утилиты файлового ввода‑вывода: вычисление today‑директории inbox, атомарная запись JSON с временным файлом и `os.replace`, сериализация.
- `scripts/api/config.py`
  - Конфиг: чтение ENV (`STORAGE_DIR`, `LOG_LEVEL`, `CORS_ALLOW_ORIGINS`) и парсинг Origins.
- `scripts/api/requirements-api.txt`
  - Зависимости: `fastapi`, `uvicorn`, `pydantic`, `python-dotenv`.
- `scripts/api/Dockerfile`
  - Базовый образ `python:3.12-slim`, установка зависимостей, user `app` (uid 10001), запуск uvicorn на 8080.
- `scripts/api/.env.sample`
  - Пример ENV для контейнера (`STORAGE_DIR`, `LOG_LEVEL`, `CORS_ALLOW_ORIGINS`).
- `scripts/api/README.md`
  - Краткая инструкция сборки/запуска локально и список эндпоинтов.
- `scripts/deploy/deploy-api.sh`
  - Оркестрация деплоя: `git pull`, `docker build`, останов/удаление старого контейнера, запуск нового с пробросом `/var/redpen-data` и `.env`, health‑check. Переменные деплоя через ENV (`IMAGE_NAME`, `CONTAINER_NAME`, `API_CONTEXT_DIR`, `DATA_DIR`, `PORT`, `ENV_FILE`).

Инфраструктура/обработка контента и тесты
- `scripts/`
  - `extract_images.py` / `extract_text.py` / `generate_annotations.py` / `process_pdf.py` — pipeline для извлечения изображений/текста из PDF и подготовки данных.
  - `publish_data.py` — публикация данных в репозитории контента (подмодуль).
  - `requirements.txt` — зависимости для pipeline.
- `tests/`
  - `annotation_position_tests.py` — playwright‑тесты позиционирования кружков на разных размерах окна; `baseline_positions.json` и вспомогательные скрипты.

Подмодули Git
- `redpen-content` (контент: изображения, текст, аннотации).
- `redpen-publish` (паблиш статического сайта).
- На сервере API можно работать без подмодулей (для сборки службы они не нужны).

## Ключевые поведенческие моменты редактора
- Нулевая регрессия: весь код редактора активируется только при `editorMode`; вне его DOM/события/сеть не трогаются.
- Подсветка выбранного маркера (`.is-selected`), обновление поп‑апа и позиционирования после изменений.
- Отложенная загрузка содержимого general (не подставлять «Загрузка…» в textarea).
- Валидация для кнопок: content обязателен; coords обязательны для `main`/`comment` и запрещены для `general`.
- «Показать» обновляет и изначально загруженные комментарии (их кружки/поп‑апы) — единая точка upsert.

## Связанные файлы конфигурации/оркестрации
- `docker-compose.yml` — сервисы `frontend`, `api`, `caddy`, `content-sync`; тома `content_data` (статические артефакты) и `redpen_data` (инбокс API); переменные окружения для CORS/доменов.
- `caddy/` — конфигурация реверс‑прокси (внешний каталог, путь проброшен в контейнер `caddy`).

## Примечания по состоянию интеграции
- Режим «Отправить» в редакторе сейчас работает в «мок»‑режиме, готов к подключению к API шагов 2–5: аутентификация, CSRF, эндпоинты страниц/аннотаций, optimistic locking.
- Все функции просмотра не зависят от редактора: без `?editor=1` редакторский код не активен.
