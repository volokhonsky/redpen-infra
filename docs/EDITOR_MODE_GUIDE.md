# Режим редактора аннотаций (MVP) — инструкция

Эта инструкция поможет включить и использовать редактор аннотаций поверх текущего вьюера RedPen. В обычном режиме сайт работает как раньше, редактор не активен и ничего не меняет.

## 1) Как включить редактор
Есть два способа включить режим редактора:

- Через параметр в адресной строке: добавить `?editor=1` к URL документа.
  Пример:
  `http://localhost:63343/redpen/redpen-publish/medinsky11klass/index.html?editor=1`

- Через глобальный флаг в консоли:
  Откройте страницу документа и в DevTools выполните:
  `window.REDPEN_EDITOR = true; window.RedPenEditor?.init && window.RedPenEditor.init();`

Если вы заходите через корневую страницу-выбор документов (`/redpen-publish/index.html?editor=1`), параметр `editor=1` автоматически прокинется в ссылку на документ.

## 2) Что вы увидите в редакторском режиме
- Правая колонка (где обычно список комментариев) будет заменена на панель:
  «Редактор аннотаций» с полями:
  - Тип: select [main, comment, general]
  - Координата: readonly поле «кликните по странице»
  - Содержимое: textarea
  - Кнопки: «Сохранить», «Отмена»
- В шапке панели есть блок авторизации: кнопка «Войти» (или «Вы вошли как …» после входа).

Если панель не появилась, см. раздел «Трудности и диагностика» ниже.

## 3) Как пользоваться
1. Выбор типа:
   - general — общий комментарий без координат (поле «Координата» скрывается)
   - main или comment — точечные комментарии (нужны координаты)
2. Задать координаты:
   - Выберите тип main или comment.
   - Кликните по изображению страницы — координаты отобразятся в поле «Координата» как `[x, y]` (в пикселях оригинального изображения).
3. Редактирование существующих аннотаций:
   - Клик по маркеру на изображении: в форму загружаются поля этой аннотации (тип, текст, координаты). Маркер подсвечивается.
4. Валидация:
   - Тип обязателен
   - Содержимое (textarea) обязательно, не пустое
   - Для general координаты запрещены
   - Для main/comment координаты обязательны
   - Кнопка «Сохранить» активируется, когда все условия соблюдены
5. Сохранение:
   - Нажмите «Сохранить». Если это новая аннотация — отправится POST; если редактируем существующую — PUT.
   - По успеху список аннотаций обновится, новый/обновлённый маркер перерисуется.
   - Появится тост «Сохранено».
6. Отмена:
   - Нажмите «Отмена», чтобы сбросить текущий черновик и снять выделение маркера.

## 4) Авторизация
- При первом сохранении (в «боевом» режиме) может потребоваться вход.
- Нажмите «Войти» в правом верхнем углу панели, введите личный токен и подтвердите.
- После успешного входа в шапке будет «Вы вошли как {username}».
- В случае ответа 401 на защищённый запрос — откроется экран входа.
- В случае 409 (конфликт версий) — появится предупреждение: обновите страницу.

## 5) Мок-режим (локальная разработка)
Если API недоступен, можно имитировать ответы сервера:
- В консоли страницы установите: `window.REDPEN_MOCKS = true;`
- Затем включите редактор (через `?editor=1` или `window.REDPEN_EDITOR=true`), 
- Сохранения будут выполняться локально без реального сервера, аутентификация также имитируется.

Важно: без включённого редактора мок-сеть не активируется и не влияет на вьюер.

## 6) Частые вопросы

— Ничего не изменилось при `?editor=1`.
1) Убедитесь, что вы открываете документ по адресу вида:
   `.../redpen-publish/medinsky11klass/index.html?editor=1`
2) Сделайте «жёсткое» обновление страницы (Ctrl+F5 / Cmd+Shift+R), чтобы сбросить кэш.
3) Проверьте, что внизу страницы подключены `../js/editor.js` и `../css/editor.css` (это автоматом делает билд-скрипт).
4) В консоли выполните:
   - `typeof window.RedPenEditor` — должно быть `object`.
   - `window.RedPenEditor.state.editorMode` — должно быть `true`.
   - Если `false`, попробуйте: `window.REDPEN_EDITOR = true; window.RedPenEditor.init();`
5) Убедитесь, что у вас действительно открыта версия из папки `redpen-publish`, а не старые файлы из других путей.

— Панель появилась, но координаты не ставятся.
- Проверьте, что выбран тип `main` или `comment`.
- Клик должен быть внутри изображения (курсор — над страницей). Поле «Координата» заполнится вида `[x, y]`.

— Нажимаю на маркер — ничего не загружается в форму.
- Убедитесь, что маркеры присутствуют (аннотации для страницы есть). Клик по маркеру подсвечивает его и заполняет форму.

— Как вернуться к обычному вьюеру?
- Уберите `?editor=1` из адресной строки и обновите страницу, либо поставьте `window.REDPEN_EDITOR = false` и обновите.

## 7) Краткий чек‑лист включения
1) Перейти по URL документа c `?editor=1`.
2) Убедиться, что справа есть «Редактор аннотаций».
3) Выбрать тип, кликнуть по странице (для main/comment) → увидеть координаты.
4) Ввести текст, нажать «Сохранить». При необходимости — «Войти».

## 8) Для разработчиков
- Проверка наличия редактора в DOM: `document.querySelector('.redpen-editor')`.
- Выделение маркера при выборе аннотации: `#overlay-container .circle.is-selected`.
- Перерендер маркеров: вызывается существующей функцией `repositionAnnotations()`.
- Режим включается строго по флагу: `?editor=1` ИЛИ `window.REDPEN_EDITOR === true`.

Если вы выполняли локальную пересборку, используйте:
```
python scripts/build_website.py --skip-tests --skip-push
```
После билда убедитесь, что `redpen-publish/medinsky11klass/index.html` содержит подключения `../js/editor.js` и `../css/editor.css` и открывайте именно этот документ с `?editor=1`.
